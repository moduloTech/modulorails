#!/usr/bin/env bash

# Script de migration vers Traefik pour les projets Rails existants
# Usage: ./migrate_to_traefik [chemin_projet]

set -e

PROJECT_DIR="${1:-.}"
PROJECT_DIR=$(cd "$PROJECT_DIR" && pwd)
PROJECT_NAME=$(basename "$PROJECT_DIR")

echo "🔄 Migration de $PROJECT_NAME vers Traefik..."
echo ""

# Validation
COMPOSE_FILE=""
if [ -f "$PROJECT_DIR/.devcontainer/compose.yml" ]; then
    COMPOSE_FILE="$PROJECT_DIR/.devcontainer/compose.yml"
    CONFIG_TYPE="devcontainer"
elif [ -f "$PROJECT_DIR/docker-compose.yml" ]; then
    COMPOSE_FILE="$PROJECT_DIR/docker-compose.yml"
    CONFIG_TYPE="compose"
else
    echo "❌ Aucun fichier compose trouvé dans $PROJECT_DIR"
    echo "   Fichiers attendus: .devcontainer/compose.yml ou docker-compose.yml"
    exit 1
fi

echo "📁 Type de configuration détecté: $CONFIG_TYPE"
echo "📄 Fichier compose: $COMPOSE_FILE"
echo ""

# Backup
BACKUP_DIR="$PROJECT_DIR/.traefik-migration-backup-$(date +%Y%m%d-%H%M%S)"
mkdir -p "$BACKUP_DIR"

echo "📦 Création du backup dans $BACKUP_DIR..."

if [ "$CONFIG_TYPE" = "devcontainer" ]; then
    cp "$PROJECT_DIR/.devcontainer/compose.yml" "$BACKUP_DIR/"
    [ -f "$PROJECT_DIR/.devcontainer/devcontainer.json" ] && cp "$PROJECT_DIR/.devcontainer/devcontainer.json" "$BACKUP_DIR/"
    [ -f "$PROJECT_DIR/.devcontainer/.env" ] && cp "$PROJECT_DIR/.devcontainer/.env" "$BACKUP_DIR/"
else
    cp "$PROJECT_DIR/docker-compose.yml" "$BACKUP_DIR/"
fi

[ -f "$PROJECT_DIR/.env" ] && cp "$PROJECT_DIR/.env" "$BACKUP_DIR/"

echo "✅ Backup créé"
echo ""

# Créer le fichier .env
ENV_FILE=""
if [ "$CONFIG_TYPE" = "devcontainer" ]; then
    ENV_FILE="$PROJECT_DIR/.devcontainer/.env"
else
    ENV_FILE="$PROJECT_DIR/.env"
fi

if [ ! -f "$ENV_FILE" ]; then
    echo "📝 Création de $ENV_FILE..."
    echo "COMPOSE_PROJECT_NAME=$PROJECT_NAME" > "$ENV_FILE"
elif ! grep -q "COMPOSE_PROJECT_NAME" "$ENV_FILE"; then
    echo "📝 Ajout de COMPOSE_PROJECT_NAME à $ENV_FILE..."
    echo "" >> "$ENV_FILE"
    echo "COMPOSE_PROJECT_NAME=$PROJECT_NAME" >> "$ENV_FILE"
else
    echo "✅ COMPOSE_PROJECT_NAME déjà présent dans $ENV_FILE"
fi

echo ""
echo "═══════════════════════════════════════════════════════════════"
echo "⚠️  MODIFICATIONS MANUELLES REQUISES"
echo "═══════════════════════════════════════════════════════════════"
echo ""
echo "Éditez le fichier: $COMPOSE_FILE"
echo ""
echo "1. AJOUTER les réseaux en fin de fichier:"
echo "   ─────────────────────────────────────"
cat << 'EOF'
networks:
  development:
    external: true
    name: development
  traefik-proxy:
    external: true
    name: traefik-proxy
  default:
EOF
echo ""
echo "2. MODIFIER le service 'app':"
echo "   ─────────────────────────"
echo "   - Supprimer les 'ports:' exposés"
echo "   - Ajouter:"
cat << EOF
    networks:
      - default
      - development
      - traefik-proxy
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.\${COMPOSE_PROJECT_NAME:-$PROJECT_NAME}-app.rule=Host(\`\${COMPOSE_PROJECT_NAME:-$PROJECT_NAME}.localhost\`)"
      - "traefik.http.routers.\${COMPOSE_PROJECT_NAME:-$PROJECT_NAME}-app.entrypoints=web"
      - "traefik.http.services.\${COMPOSE_PROJECT_NAME:-$PROJECT_NAME}-app.loadbalancer.server.port=3000"
EOF
echo ""
echo "3. MODIFIER le service 'database':"
echo "   ──────────────────────────────"
echo "   - Supprimer 'expose:' ou 'ports:'"
echo "   - Ajouter:"
cat << 'EOF'
    networks:
      - default
EOF
echo ""
echo "4. MODIFIER le service 'redis':"
echo "   ───────────────────────────"
echo "   - Supprimer 'expose:' ou 'ports:'"
echo "   - Ajouter:"
cat << 'EOF'
    networks:
      - default
EOF
echo ""
echo "5. MODIFIER le service 'mailcatcher' (si présent):"
echo "   ───────────────────────────────────────────────"
echo "   - Supprimer 'expose:' ou 'ports:'"
echo "   - Ajouter:"
cat << EOF
    networks:
      - default
      - traefik-proxy
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.\${COMPOSE_PROJECT_NAME:-$PROJECT_NAME}-mail.rule=Host(\`mail.\${COMPOSE_PROJECT_NAME:-$PROJECT_NAME}.localhost\`)"
      - "traefik.http.routers.\${COMPOSE_PROJECT_NAME:-$PROJECT_NAME}-mail.entrypoints=web"
      - "traefik.http.services.\${COMPOSE_PROJECT_NAME:-$PROJECT_NAME}-mail.loadbalancer.server.port=1080"
EOF
echo ""

if [ "$CONFIG_TYPE" = "devcontainer" ]; then
    echo "6. MODIFIER devcontainer.json:"
    echo "   ────────────────────────────"
    echo "   - Changer \"name\" en:"
    echo "     \"name\": \"\${localEnv:COMPOSE_PROJECT_NAME:$PROJECT_NAME}\","
    echo "   - Vider \"forwardPorts\":"
    echo "     \"forwardPorts\": [],"
    echo "   - Ajouter \"remoteEnv\":"
    cat << EOF
    "remoteEnv": {
      "COMPOSE_PROJECT_NAME": "\${localEnv:COMPOSE_PROJECT_NAME:$PROJECT_NAME}"
    },
EOF
    echo ""
fi

echo "═══════════════════════════════════════════════════════════════"
echo ""
echo "📋 Après les modifications:"
echo "   1. Assurez-vous que Traefik est démarré:"
echo "      cd ~/traefik && docker compose up -d"
echo ""
echo "   2. Créez les réseaux Docker si nécessaire:"
echo "      docker network create traefik-proxy 2>/dev/null || true"
echo "      docker network create development 2>/dev/null || true"
echo ""
echo "   3. Testez le projet:"
echo "      cd $PROJECT_DIR && rails-dev"
echo ""
echo "   4. Accédez à l'application:"
echo "      http://$PROJECT_NAME.localhost"
echo ""
echo "📦 En cas de problème, restaurez depuis:"
echo "   $BACKUP_DIR"
echo ""
