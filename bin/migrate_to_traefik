#!/usr/bin/env bash

# Migration script to Traefik for existing Rails projects
# Usage: ./migrate_to_traefik [project_path]

set -e

PROJECT_DIR="${1:-.}"
PROJECT_DIR=$(cd "$PROJECT_DIR" && pwd)
PROJECT_NAME=$(basename "$PROJECT_DIR")

echo "🔄 Migrating $PROJECT_NAME to Traefik..."
echo ""

# Validation
COMPOSE_FILE=""
if [ -f "$PROJECT_DIR/.devcontainer/compose.yml" ]; then
    COMPOSE_FILE="$PROJECT_DIR/.devcontainer/compose.yml"
    CONFIG_TYPE="devcontainer"
elif [ -f "$PROJECT_DIR/docker-compose.yml" ]; then
    COMPOSE_FILE="$PROJECT_DIR/docker-compose.yml"
    CONFIG_TYPE="compose"
else
    echo "❌ No compose file found in $PROJECT_DIR"
    echo "   Expected files: .devcontainer/compose.yml or docker-compose.yml"
    exit 1
fi

echo "📁 Configuration type detected: $CONFIG_TYPE"
echo "📄 Compose file: $COMPOSE_FILE"
echo ""

# Backup
BACKUP_DIR="$PROJECT_DIR/.traefik-migration-backup-$(date +%Y%m%d-%H%M%S)"
mkdir -p "$BACKUP_DIR"

echo "📦 Creating backup in $BACKUP_DIR..."

if [ "$CONFIG_TYPE" = "devcontainer" ]; then
    cp "$PROJECT_DIR/.devcontainer/compose.yml" "$BACKUP_DIR/"
    [ -f "$PROJECT_DIR/.devcontainer/devcontainer.json" ] && cp "$PROJECT_DIR/.devcontainer/devcontainer.json" "$BACKUP_DIR/"
    [ -f "$PROJECT_DIR/.devcontainer/.env" ] && cp "$PROJECT_DIR/.devcontainer/.env" "$BACKUP_DIR/"
else
    cp "$PROJECT_DIR/docker-compose.yml" "$BACKUP_DIR/"
fi

[ -f "$PROJECT_DIR/.env" ] && cp "$PROJECT_DIR/.env" "$BACKUP_DIR/"

echo "✅ Backup created"
echo ""

# Create .env file
ENV_FILE=""
if [ "$CONFIG_TYPE" = "devcontainer" ]; then
    ENV_FILE="$PROJECT_DIR/.devcontainer/.env"
else
    ENV_FILE="$PROJECT_DIR/.env"
fi

if [ ! -f "$ENV_FILE" ]; then
    echo "📝 Creating $ENV_FILE..."
    echo "COMPOSE_PROJECT_NAME=$PROJECT_NAME" > "$ENV_FILE"
elif ! grep -q "COMPOSE_PROJECT_NAME" "$ENV_FILE"; then
    echo "📝 Adding COMPOSE_PROJECT_NAME to $ENV_FILE..."
    echo "" >> "$ENV_FILE"
    echo "COMPOSE_PROJECT_NAME=$PROJECT_NAME" >> "$ENV_FILE"
else
    echo "✅ COMPOSE_PROJECT_NAME already present in $ENV_FILE"
fi

echo ""
echo "═══════════════════════════════════════════════════════════════"
echo "⚠️  MANUAL CHANGES REQUIRED"
echo "═══════════════════════════════════════════════════════════════"
echo ""
echo "Edit the file: $COMPOSE_FILE"
echo ""
echo "1. ADD networks at the end of file:"
echo "   ─────────────────────────────────────"
cat << 'EOF'
networks:
  traefik-proxy:
    external: true
    name: traefik-proxy
  default:
EOF
echo ""
echo "2. MODIFY the 'app' service:"
echo "   ─────────────────────────"
echo "   - Remove exposed 'ports:'"
echo "   - Add:"
cat << EOF
    networks:
      - default
      - traefik-proxy
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.\${COMPOSE_PROJECT_NAME:-$PROJECT_NAME}-app.rule=Host(\`\${COMPOSE_PROJECT_NAME:-$PROJECT_NAME}.localhost\`)"
      - "traefik.http.routers.\${COMPOSE_PROJECT_NAME:-$PROJECT_NAME}-app.entrypoints=web"
      - "traefik.http.services.\${COMPOSE_PROJECT_NAME:-$PROJECT_NAME}-app.loadbalancer.server.port=3000"
EOF
echo ""
echo "3. MODIFY the 'database' service:"
echo "   ──────────────────────────────"
echo "   - Remove 'expose:' or 'ports:'"
echo "   - Add:"
cat << 'EOF'
    networks:
      - default
EOF
echo ""
echo "4. MODIFY the 'redis' service:"
echo "   ───────────────────────────"
echo "   - Remove 'expose:' or 'ports:'"
echo "   - Add:"
cat << 'EOF'
    networks:
      - default
EOF
echo ""
echo "5. MODIFY the 'mailcatcher' service (if present):"
echo "   ───────────────────────────────────────────────"
echo "   - Remove 'expose:' or 'ports:'"
echo "   - Add:"
cat << EOF
    networks:
      - default
      - traefik-proxy
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.\${COMPOSE_PROJECT_NAME:-$PROJECT_NAME}-mail.rule=Host(\`mail.\${COMPOSE_PROJECT_NAME:-$PROJECT_NAME}.localhost\`)"
      - "traefik.http.routers.\${COMPOSE_PROJECT_NAME:-$PROJECT_NAME}-mail.entrypoints=web"
      - "traefik.http.services.\${COMPOSE_PROJECT_NAME:-$PROJECT_NAME}-mail.loadbalancer.server.port=1080"
EOF
echo ""

if [ "$CONFIG_TYPE" = "devcontainer" ]; then
    echo "6. MODIFY devcontainer.json:"
    echo "   ────────────────────────────"
    echo "   - Change \"name\" to:"
    echo "     \"name\": \"\${localEnv:COMPOSE_PROJECT_NAME:$PROJECT_NAME}\","
    echo "   - Empty \"forwardPorts\":"
    echo "     \"forwardPorts\": [],"
    echo "   - Add \"remoteEnv\":"
    cat << EOF
    "remoteEnv": {
      "COMPOSE_PROJECT_NAME": "\${localEnv:COMPOSE_PROJECT_NAME:$PROJECT_NAME}"
    },
EOF
    echo ""
fi

echo "═══════════════════════════════════════════════════════════════"
echo ""
echo "📋 After making the changes:"
echo "   1. Ensure Traefik is running:"
echo "      cd ~/traefik && docker compose up -d"
echo ""
echo "   2. Create Docker networks if needed:"
echo "      docker network create traefik-proxy 2>/dev/null || true"
echo ""
echo "   3. Test the project:"
echo "      cd $PROJECT_DIR && docker compose up -d"
echo ""
echo "   4. Access the application:"
echo "      http://$PROJECT_NAME.localhost"
echo ""
echo "📦 In case of issues, restore from:"
echo "   $BACKUP_DIR"
echo ""
