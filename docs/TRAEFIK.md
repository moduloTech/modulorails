# Traefik Configuration for Rails Projects

This documentation describes the Traefik integration as a reverse proxy for Rails projects generated by Modulorails.

## Overview

Traefik allows running multiple Rails projects simultaneously without port conflicts. Each project is accessible via a dedicated `.localhost` subdomain:

- Application: `http://{project}.localhost`
- Mailcatcher: `http://mail.{project}.localhost`

## Prerequisites

### 1. DNS Configuration (macOS)

Install and configure dnsmasq to resolve `.localhost` domains:

```bash
# Installation
brew install dnsmasq

# Configuration
echo 'address=/.localhost/127.0.0.1' > $(brew --prefix)/etc/dnsmasq.conf

# Start the service
sudo brew services start dnsmasq

# Configure the resolver
sudo mkdir -p /etc/resolver
echo "nameserver 127.0.0.1" | sudo tee /etc/resolver/localhost
```

### 2. DNS Configuration (Linux)

On Linux, you can use systemd-resolved or modify `/etc/hosts`:

```bash
# Option 1: Add to /etc/hosts (for each project)
echo "127.0.0.1 my-project.localhost mail.my-project.localhost" | sudo tee -a /etc/hosts

# Option 2: Use dnsmasq
sudo apt install dnsmasq
echo 'address=/.localhost/127.0.0.1' | sudo tee /etc/dnsmasq.d/localhost.conf
sudo systemctl restart dnsmasq
```

### 3. Global Traefik Infrastructure Setup

Create a global Traefik infrastructure directory:

```bash
mkdir -p ~/traefik
```

Create `~/traefik/docker-compose.yml`:

```yaml
services:
  traefik:
    image: traefik:v3.0
    container_name: traefik
    restart: unless-stopped
    command:
      - "--api.dashboard=true"
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network=traefik-proxy"
      - "--entrypoints.web.address=:80"
      - "--log.level=INFO"
      - "--accesslog=true"
    ports:
      - "80:80"
      - "8080:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - traefik-proxy
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dashboard.rule=Host(`traefik.localhost`)"
      - "traefik.http.routers.dashboard.service=api@internal"

networks:
  traefik-proxy:
    name: traefik-proxy
```

### 4. Create Docker Network

```bash
docker network create traefik-proxy
```

### 5. Start Traefik

```bash
cd ~/traefik && docker compose up -d
```

## Usage

### Start a Project

```bash
cd my-project
docker compose -f .devcontainer/compose.yml up -d
```

Or open with VS Code devcontainer.

### Access URLs

- Application: `http://{project-name}.localhost`
- Mailcatcher: `http://mail.{project-name}.localhost`
- Traefik Dashboard: `http://traefik.localhost`

### Stop a Project

```bash
cd my-project
docker compose -f .devcontainer/compose.yml down
```

## New Projects

New projects generated by Modulorails automatically include the Traefik configuration. No additional action is required.

## Migrating Existing Projects

To migrate an existing project to Traefik:

```bash
./bin/migrate_to_traefik /path/to/project
```

This script:
1. Creates a backup of the existing configuration
2. Creates the `.env` file with `COMPOSE_PROJECT_NAME`
3. Displays the manual changes to be made

### Manual Changes Required

#### In `compose.yml` or `docker-compose.yml`

1. **Add networks** at the end of the file:

```yaml
networks:
  traefik-proxy:
    external: true
    name: traefik-proxy
  default:
```

2. **Modify the `app` service**:

```yaml
services:
  app:
    # ... existing configuration ...
    networks:
      - default
      - traefik-proxy
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME}-app.rule=Host(`${COMPOSE_PROJECT_NAME}.localhost`)"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME}-app.entrypoints=web"
      - "traefik.http.services.${COMPOSE_PROJECT_NAME}-app.loadbalancer.server.port=3000"
    # Remove: ports: ["3000:3000"]
```

3. **Modify internal services** (`database`, `redis`):

```yaml
  database:
    # ... existing configuration ...
    networks:
      - default
    # Remove: expose or ports
```

4. **Modify `mailcatcher`**:

```yaml
  mailcatcher:
    # ... existing configuration ...
    networks:
      - default
      - traefik-proxy
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME}-mail.rule=Host(`mail.${COMPOSE_PROJECT_NAME}.localhost`)"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME}-mail.entrypoints=web"
      - "traefik.http.services.${COMPOSE_PROJECT_NAME}-mail.loadbalancer.server.port=1080"
    # Remove: expose or ports
```

#### In `devcontainer.json` (if applicable)

```json
{
  "name": "${localEnv:COMPOSE_PROJECT_NAME:project-name}",
  "forwardPorts": [],
  "remoteEnv": {
    "COMPOSE_PROJECT_NAME": "${localEnv:COMPOSE_PROJECT_NAME:project-name}"
  }
}
```

## Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                         Browser                                  │
│                                                                  │
│   http://project-a.localhost    http://project-b.localhost      │
│              │                          │                        │
└──────────────┼──────────────────────────┼────────────────────────┘
               │                          │
               ▼                          ▼
┌─────────────────────────────────────────────────────────────────┐
│                         Traefik                                  │
│                     (Port 80)                                   │
│                                                                  │
│   - Routes by Host header                                        │
│   - Dashboard: http://traefik.localhost                         │
└─────────────────────────────────────────────────────────────────┘
               │                          │
               │  traefik-proxy           │  traefik-proxy
               │  network                 │  network
               ▼                          ▼
┌──────────────────────────┐ ┌──────────────────────────┐
│      Project A           │ │      Project B           │
│                          │ │                          │
│ ┌──────────────────────┐ │ │ ┌──────────────────────┐ │
│ │   App (Port 3000)    │ │ │ │   App (Port 3000)    │ │
│ └──────────────────────┘ │ │ └──────────────────────┘ │
│ ┌──────────────────────┐ │ │ ┌──────────────────────┐ │
│ │   Database           │ │ │ │   Database           │ │
│ └──────────────────────┘ │ │ └──────────────────────┘ │
│ ┌──────────────────────┐ │ │ ┌──────────────────────┐ │
│ │   Redis              │ │ │ │   Redis              │ │
│ └──────────────────────┘ │ │ └──────────────────────┘ │
│ ┌──────────────────────┐ │ │ ┌──────────────────────┐ │
│ │   Mailcatcher        │ │ │ │   Mailcatcher        │ │
│ └──────────────────────┘ │ │ └──────────────────────┘ │
│                          │ │                          │
│      default network     │ │      default network     │
└──────────────────────────┘ └──────────────────────────┘
```

## Docker Networks

- **traefik-proxy**: Connects Traefik to exposed services (app, mailcatcher)
- **default**: Internal project network (database, redis)

## Environment Variables

| Variable | Description | Example |
|----------|-------------|---------|
| `COMPOSE_PROJECT_NAME` | Project name (used for Traefik routes) | `my-project` |

## Troubleshooting

### Traefik Won't Start

Check that no other service is using port 80:

```bash
sudo lsof -i :80
```

### .localhost Domains Don't Work

1. Check that dnsmasq is active:
   ```bash
   sudo brew services list | grep dnsmasq
   ```

2. Test DNS resolution:
   ```bash
   nslookup test.localhost 127.0.0.1
   ```

### A Project Is Not Accessible

1. Check that the container is on the traefik-proxy network:
   ```bash
   docker network inspect traefik-proxy
   ```

2. Check Traefik labels:
   ```bash
   docker inspect <container_name> | grep -A 20 Labels
   ```

3. Check Traefik logs:
   ```bash
   docker logs traefik
   ```

### "Network not found" Error

Create the network manually:

```bash
docker network create traefik-proxy
```

## URL Reference

| Service | URL |
|---------|-----|
| Application | `http://{project}.localhost` |
| Mailcatcher | `http://mail.{project}.localhost` |
| Traefik Dashboard | `http://traefik.localhost` |
